@page "/login"
@using System.Net.Http
@inject NavigationManager Navigation
@inject Blazor.Services.APIService ApiService
@inject Blazor.Services.AdAuthClientService AdAuthClientService

@if (showMessage)
{
    <div class="error-box">
        ❌ @errorMessage
    </div>
}

<div class="form-wrapper">
    <h3>Login</h3>
    <EditForm model="user" method="post" OnValidSubmit="() => HandleSubmitAsync()" FormName="LoginForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="text-field">
            <label for="email">E-mail:</label>
            <InputText id="email" @bind-Value="user.Email" class="input" />
            <ValidationMessage For="@(() => user.Email)" />
        </div>

        <div class="text-field">
            <label for="password">Password:</label>
            <InputText id="password" type="password" @bind-Value="user.Password" class="input" />
            <ValidationMessage For="@(() => user.Password)" />
        </div>

        <button type="submit" class="submit-button">LOGIN</button>

        <p class="to-register">
            Don't have an account? <a href="/register">Register now</a>
        </p>
    </EditForm>
</div>

<hr />

<div class="form-wrapper">
    <h3>Login with Active Directory</h3>
    <EditForm model="adForm" OnValidSubmit="() => HandleAdLoginAsync()">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="text-field">
            <label for="ad-username">AD Username (samAccountName):</label>
            <InputText id="ad-username" @bind-Value="adForm.Username" class="input" />
        </div>

        <div class="text-field">
            <label for="ad-password">Password:</label>
            <InputText id="ad-password" type="password" @bind-Value="adForm.Password" class="input" />
        </div>

        <button type="button" class="submit-button" @onclick="HandleAdLoginAsync">LOGIN WITH AD</button>

        @if (showAdMessage)
        {
            <div class="error-box">❌ @adErrorMessage</div>
        }
    </EditForm>
</div>

@code {
    UserLoginDto user = new UserLoginDto();
    string errorMessage = "Incorrect login or password. Please try again.";
    bool showMessage = false;

    // AD login state
    private AdLoginModel adForm = new();
    string adErrorMessage = "AD login failed. Check your username/password.";
    bool showAdMessage = false;

    private async Task HandleSubmitAsync()
    {
        showMessage = false;

        bool success = await ApiService.Login(user);

        if (success)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            showMessage = true;
        }
    }

    private async Task HandleAdLoginAsync()
    {
        showAdMessage = false;
        try
        {
            var (ok, err) = await AdAuthClientService.LoginWithAdAsync(adForm.Username, adForm.Password);
            if (ok)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                adErrorMessage = string.IsNullOrWhiteSpace(err) ? adErrorMessage : err;
                showAdMessage = true;
            }
        }
        catch (Exception ex)
        {
            adErrorMessage = ex.Message;
            showAdMessage = true;
        }
    }

    private class AdLoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
